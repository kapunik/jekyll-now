---
layout: post
title: Как колька сервер подымал
---

Ниже приведен перечень произведенных манипуляций, для создания сервера для node.js без апачей и пыхапе.
Всё нижеперечисленное было узнато у Гугла и Стаковерлоу — моих бессменных учителей.
Листинг существует на тот случай, если мне опять придется это повторить.

## Создание сервера и юзера
Нажал на кнопку «установить сервер убунту 16.04» (в контрольной панели хостинга);
Нажал на кнопку «приделать выделенный айпи» (там-же);
Создал пароль для root (всё тамже);
Открыл консоль (в своей бубунте, на ноуте), скопировал на хостинге строчку
```
ssh root@**.***.**.**
```
вставил в консоль, нажал Энтер.

Консоль спросила пароль, я ей признался, она мне написала в ответ
```
root@ovz1:~#
```
что означает успешный коннект.

Как сообщает Гугол, под рутом лучче не ползать, ато эшельме-пешельме-шайтанама и вобщем я сам боюсь. Создаю нового юзера с sudo, пишу в консольке:
```
root@ovz1:~# adduser kapu
```
На что он мне отвечает:
```
Adding user `kapu' ...
Adding new group `kapu' (1000) ...
Adding new user `kapu' (1000) with group `kapu' ...
Creating home directory `/home/kapu' ...
Copying files from `/etc/skel' ...
```
Просит придумать пароль, и повторить его (п.с. в бубунте, когда пароли вводишь в консолях — оно не отображается, ни звездочек, ни каких символов, пишите и не очкуйте, я помню растерялся в первый раз)
```
Enter new UNIX password:  
Retype new UNIX password: 
passwd: password updated successfully
Changing the user information for kapu
Enter the new value, or press ENTER for the default
	Full Name []: kapusta
	Room Number []: 
	Work Phone []: 
	Home Phone []: 
	Other []: 
Is the information correct? [Y/n] y
```
Ввели всё что он просил, теперь нужно добавить юзера в группу судо:
```
root@ovz1:~# usermod -aG sudo kapu
root@ovz1:~# logout
Connection to **.***.**.** closed.
```
Логаут в ssh делается с помощью контрл+D

Коннектимся поновой новым юзером:
```
kapu@kaputer:~$ ssh kapu@ **.***.**.**
kapu@**.***.**.**'s password: 
Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 2.6.32-042stab123.9 x86_64)
```
Там еще можно настроить доступ в ssh по связке ключей, но я этого делать не стал, для меня это непостижимая магия.

## Настройка фаервола.

Следующая команда покажет, какие соединения разрешены фаерволом:
```
$ sudo ufw app list
```
Если фаервол UFW не включен, то он скажет, то что сказал мне:
```
sudo: ufw: command not found
```
Устанавливаем UFW
```
$ sudo apt-get install ufw
```
Бубунта ответил:
```
Чтение списков пакетов… Готово
Построение дерева зависимостей… Готово
Пакет ufw недоступен, но упомянут в списке зависимостей другого пакета.
Это может означать, что пакет отсутствует, устарел, или доступен из источников, не упомянутых в sources.list

E: Для пакета «ufw» не найден кандидат на установку
```
Делаю обновление списка пакетов из репозиториев
```
$  sudo apt update
```
Затем снова
```
$ sudo apt-get install ufw
```
Готово!
Чтоб разрешить в фаерволе доступ по ssh я ввел
```
$  sudo ufw allow OpenSSH
$  sudo ufw enable
```
После чего не смог сконнектится по ssh с сервером.... чудеса
Зашел на хостинг, ребутнул сервер, зашел по shh... пишу
```
$  sudo ufw status
```
Консоль отвечает, что служба не активна (нет ее в автозагрузке, вот и пустило). Пошел в гугл, узнавать, чего это меня не пускает то...
Чтот нагуглил, повторяю то что делал до этого, плюс с еще одной строчкой, которая дает понять UFW что произошли изменения:
```
$  sudo ufw allow OpenSSH
$  sudo ufw app update OpenSSH
$  sudo ufw enable
```
Опять всё крякнулось. Гуглю предсмертную строчку из терминала:
```
kapu@ovz1:~$ sudo ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
ERROR: problem running ufw-init
```
Становится ясно — произошла какая-то бяка! Фаервол пытается задействовать какие-то штуки, доступные только на сервере, со своим родным железом. На OVZ — фиг без масла. Удаляем UFW к чертовой бабушке.
```
$  sudo apt-get purge ufw
```
Будем считать первичную настройку бубунты завершенной. Фиг с ним с уфв (в конечном счете, это не совсем фаервол, а надстройка над айпитаблес). В случае чего, всё можно подглядеть вот здесь https://ubuntuclub.org/zashhita-servera-ot-nesanktsionirovannogo-dostupa-nastraivaem-brandmauer-na-ubuntu/

## Настройка ftp

Действовать буду, согласно этому мануалу http://help.ubuntu.ru/wiki/%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE_%D0%BF%D0%BE_ubuntu_server/%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D1%8B%D0%B5_%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0/ftp_server

Установим vsftpd:
```
$  sudo apt-get install vsftpd
```
Запишем его в автозагрузку:
```
$  sudo systemctl start vsftpd
$  sudo systemctl enable vsftpd
```
Настройка авторизованного доступа
Сперва-сначала сделаем копию оригинального конфига, чтоб можно было, в случае чего, откатиться без переустановки пакета:
```
$  sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.orig
```
Чтоб открыть файл конфига в консоли, я установлю nano:
```
$  sudo apt-get install nano
```
Открываю конфиг
```
$  sudo nano /etc/vsftpd.conf
```
Раскоментировал строки
```
local_enable=YES
write_enable=YES
```
Потом нажал контрл+О (сохранился), энтер, и контрл+Х (закрыл редактор)

перезапустил vsftpd
```
$  sudo service vsftpd restart
```
Проверка — захожу на фтп под логином и паролем созданного юзера — всё ок.

Установка node.js
Заметьте, что Node.js — это не HTTP-сервер(Nginx или Apache), но на нем можно запустить HTTP-сервер, используя уже готовые библиотеки.
```
$  sudo apt-get install nodejs
$  sudo apt-get install npm
```
при установке NPM вылезло вот это
![Error](/images/error.png)

Я нажал ОК (Энтер), там что-то установилось/переустановилось, ошибок не выкатило. Ок.

Проверка:
```
$ nodejs
> 2+2
4
```
Работает!

## Выкатим свою первую страничку в инет?

Зайдя на фтпшку, с удивлением обнаружил, что немогу создать директорию domains в /var/www/
```
sudo chmod 0757 /var/www/
```
Работает.
Перехожу в папку проекта в терминале cd /var/www/domains/........
Чтоб npm сгенерировал package.json выполняю в директории проекта:
```
$ npm init
```
Пишу имя проекта, потом жму Энтер до последнего (соглашаюсь на дефолтные штуки)
Затем ставлю фреймворк Експресс (—саве записывает пакет в паскаге.джейсон)
```
$ npm install express --save
```
Иду на страничку Экспресса http://expressjs.com/ru/starter/hello-world.html
Копирую от туда всё как там написано. Создаю файлик app.js со следующим содержанием:
```javascript
var express = require('express');
var app = express();

app.get('/', function (req, res) {
  res.send('Hello World!');
});

app.listen(3000, function () {
  console.log('Example app listening on port 3000!');
});
```
Затем в консольке:
```
$ nodejs app.js
```
Заметьте, не «**node** app.js», как написано на странице экспресса а «**nodejs** app.js», потому что я ставил ноду из apt, а там она, из-за конфликта с внутренними органами бубунты назавана не нодой а nodejs
Терминал отозвался и сказал
```
Example app listening on port 3000!
```
Перешел по адресу мой.домен:3000
Ура! Работает =)

![Hello World](/images/helloworld.png)
